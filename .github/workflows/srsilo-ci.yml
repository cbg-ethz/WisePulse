name: CI

on:
  push:
    branches:
      - main
  pull_request:

env:
  DOCKER_DEPENDENCY_IMAGE_NAME: ghcr.io/genspectrum/lapis-silo-dependencies
  DOCKER_IMAGE_NAME: ghcr.io/genspectrum/lapis-silo

jobs:
  rust-checks:
    name: srSILO Rust Tools - Quality Checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('roles/srsilo/files/tools/**/Cargo.lock') }}
      
      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('roles/srsilo/files/tools/**/Cargo.lock') }}
      
      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: roles/srsilo/files/tools/target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('roles/srsilo/files/tools/**/Cargo.lock') }}
      
      - name: Check formatting
        run: cargo fmt --all -- --check
        working-directory: roles/srsilo/files/tools
      
      - name: Run clippy
        run: cargo clippy --workspace --all-targets -- -D warnings
        working-directory: roles/srsilo/files/tools
      
      - name: Build
        run: cargo build --release --workspace
        working-directory: roles/srsilo/files/tools
      
      - name: Test
        run: cargo test --workspace
        working-directory: roles/srsilo/files/tools

  # srsilo-integration:
  #   name: srSILO Pipeline - Integration Test
  #   runs-on: ubuntu-latest
  #   needs: rust-checks
  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.11'
      
  #     - name: Install Docker Compose
  #       run: |
  #         sudo apt-get update
  #         sudo apt-get install -y docker-compose
      
     
  #    * using srsilo/files/test_data
  #    * run split_sort_merge place
  #    * run silo preprocessing
  #    * startup silo
  #    * check health
