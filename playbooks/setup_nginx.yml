---
- hosts: webservers
  become: true
  vars:
    # Set to true for staging/testing environments without real certificates
    generate_self_signed_certs: false
    test_domains:
      - "db.{{ nginx_domain_name }}"
      - "auth.db.{{ nginx_domain_name }}"
      - "api.db.{{ nginx_domain_name }}"
      - "lapis.{{ nginx_domain_name }}"
      - "silo.{{ nginx_domain_name }}"
      - "{{ nginx_domain_name }}"
  pre_tasks:
    - name: Ensure Let's Encrypt directories exist
      file:
        path: "/etc/letsencrypt/live/{{ item }}"
        state: directory
        mode: '0755'
        recurse: yes
      loop: "{{ test_domains }}"
      when: generate_self_signed_certs

    - name: Generate self-signed SSL certificates
      command: >
        openssl req -x509 -nodes -days 365 -newkey rsa:2048
        -keyout /etc/letsencrypt/live/{{ item }}/privkey.pem
        -out /etc/letsencrypt/live/{{ item }}/fullchain.pem
        -subj "/C=US/ST=Test/L=Test/O=Test/CN={{ item }}"
      args:
        creates: "/etc/letsencrypt/live/{{ item }}/fullchain.pem"
      loop: "{{ test_domains }}"
      when: generate_self_signed_certs

    - name: Generate DH parameters (fast for testing)
      command: openssl dhparam -out /etc/letsencrypt/ssl-dhparams.pem 2048
      args:
        creates: /etc/letsencrypt/ssl-dhparams.pem
      when: generate_self_signed_certs

  roles:
    - nginx
